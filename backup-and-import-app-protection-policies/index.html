<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>EUC365 | Backup and Import App Protection Policies</title>

  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="An easy way to backup and import your App Protection Policies using the Microsoft Graph API and PowerShell... SCRIPT PROVIDED | EUC365">
  <meta name="author" content="David Brook">
  <meta name="generator" content="Hugo 0.75.1" />

  
  <link rel="preload" href="https://fonts.gstatic.com/s/opensans/v18/mem8YaGs126MiZpBA-UFWJ0bbck.woff2" style="font-display: optional;">
  
  
  
  <link rel="stylesheet" href="https://euc365.com/plugins/bootstrap/bootstrap.min.css" >
  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:600%7cOpen&#43;Sans&amp;display=swap" >
  
  
  
  <link rel="stylesheet" href="https://euc365.com/plugins/themify-icons/themify-icons.css" >
  
  
  
  <link rel="stylesheet" href="https://euc365.com/plugins/slick/slick.css" >
  
  
  
  <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.25/default/snipcart.css" >
  
  

  <script data-ad-client="ca-pub-6095977771709914" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
  
  <link rel="stylesheet" href="https://euc365.com/scss/style.css" media="screen">

  
  <link rel="shortcut icon" href="https://euc365.com/images/favicon.png" type="image/x-icon">
  <link rel="icon" href="https://euc365.com/images/favicon.png" type="image/x-icon">

  <meta property="og:title" content="Backup and Import App Protection Policies" />
<meta property="og:description" content="An easy way to backup and import your App Protection Policies using the Microsoft Graph API and PowerShell... SCRIPT PROVIDED | EUC365" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://euc365.com/backup-and-import-app-protection-policies/" />
<meta property="og:image" content="https://euc365.com/images/post/backupappprotection/FeaturedImage.png" />
<meta property="article:published_time" content="2020-09-18T08:49:00+00:00" />
<meta property="article:modified_time" content="2020-09-18T08:49:00+00:00" />

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-176926283-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-176926283-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  
<script src="https://cdn.cookielaw.org/consent/e7d8426b-68f5-43ed-8007-318355ad5ade/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="e7d8426b-68f5-43ed-8007-318355ad5ade" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>


</head><body><!-- navigation -->
<header class="sticky-top bg-white border-bottom border-default">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white">
      <a class="navbar-brand" href="/">
        <img class="img-fluid" width="150px" src="https://euc365.com/images/logo.png" alt="Home"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <ul class="navbar-nav ml-auto">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://euc365.com/">Home</a>
          </li>
          
          
          
          <li class="nav-item dropdown">
            <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              Posts <i class="ti-angle-down ml-1"></i>
            </a>
            <div class="dropdown-menu">
              
              <a class="dropdown-item" href="https://euc365.com/tags/autopilot">Autopilot</a>
              
              <a class="dropdown-item" href="https://euc365.com/tags/azure">Azure</a>
              
              <a class="dropdown-item" href="https://euc365.com/tags/intune">Intune</a>
              
              <a class="dropdown-item" href="https://euc365.com/tags/microsoft-graph-api">Microsoft Graph API</a>
              
              <a class="dropdown-item" href="https://euc365.com/tags/powershell">PowerShell</a>
              
            </div>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://euc365.com/about">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://euc365.com/contact">Contact</a>
          </li>
          
          
        </ul>

        
        

        
        <!-- search -->
        <div class="search px-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="/search" class="h-100">
              <input class="search-box pl-4" id="search-query" name="s" type="search" placeholder="Type &amp; Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->




<section class="section">
  <div class="container">
    <article class="row mb-4">
      <div class="col-lg-10 mx-auto mb-4">
        <h1 class="h2 mb-3">Backup and Import App Protection Policies</h1>
        <ul class="list-inline post-meta mb-3">
          <li class="list-inline-item"><i class="ti-user mr-2"></i><a
              href="/author/david-brook/">David Brook</a></li>
          <li class="list-inline-item">Date : 18 September, 2020</li>
          <li class="list-inline-item">Categories :
            <a
              href="/categories/powershell" class="ml-1">Powershell </a>
            ,<a
              href="/categories/intune" class="ml-1">Intune </a>
            </li>
          <li class="list-inline-item">Tags : <a
              href="/tags/azure" class="ml-1">Azure </a> ,<a
              href="/tags/azure-ad" class="ml-1">Azure a d </a> ,<a
              href="/tags/azure-app-registrations" class="ml-1">Azure app registrations </a> ,<a
              href="/tags/powershell" class="ml-1">Powershell </a> ,<a
              href="/tags/intune" class="ml-1">Intune </a> ,<a
              href="/tags/microsoft-graph-api" class="ml-1">Microsoft graph a p i </a> ,<a
              href="/tags/app-protection" class="ml-1">App protection </a> 
          </li>
        </ul>
      </div>
      
      

    
      <div class="col-lg-10 mx-auto">
        <div class="content"><h2 id="why-backup-app-protection-policies">Why backup App Protection Policies?</h2>
<p>Why would you need to back up something that runs in stored and hosted on Azure? Well there are numerous answers to this question really.</p>
<ul>
 	<li>If you make a change and you break something you can look back and analyse what it was</li>
 	<li>You can make copies of the policy easily rather than having two windows side by side</li>
 	<li>In case one is deleted… (Let’s hope this is never the case)</li>
 	<li>To review the maturity of your policies (Lets say you started from ground zero and now have over 100 policy settings… Might be nice to review what you’ve done)</li>
</ul>
We also live in a world of change management and service improvement  so there is always a need to make changes to policies and configurations. If you have or are moving from traditional group policy you will know that you can run an HTML report or a backup before you go ahead and make any changes.
<p>Well when using Intune there was no way to export or backup your profiles or policies from the console… I have seen people taking screenshots of the pages as a backup of the policies which is far from an ideal scenario.</p>
<p>What if I told you there is a way you can back-up your configuration policies using the Microsoft Graph API?? Well it’s possible and it’s easier than you think.</p>
<p>This is part of a series of posts about backing up and importing policies and profiles, so if you feel like you&rsquo;ve read this part before then you probably have.</p>
<p>Back when I wrote my first post about these (<a href="https://euc365.com/backing-up-intune-device-configuration-profiles/"><strong>HERE</strong></a>) the script just backed up the policies/profiles, however over time they have grown into scripts that you can also use to re-import these policies/profile.</p>
<p>This one is the <b>Fourth </b>in the series, where we will focus on <strong>App Protection Policies</strong>. Each one has brought its own challenges which are hopefully mitigated within the script, but if not you can always get in touch and let me know.</p>
<h2 id="the-script">The Script</h2>
<p>You will notice that most of this (the authentication part and most of the param block at least) are the same as my other script&hellip; But if its not broke why fix it? (Those famous last words!!!). Although this script<strong> </strong>does have an alternative run method, if you run it directly without the ClientID, ClientSecret and TenantID parameters it will install the Azure AD Powershell module and use a custom Function (<strong>Connect-AzAD_Token)</strong> to enable users to interact with a login Window if they do not wish to use Azure AD App Registrations with client secrets.</p>
<p>This script can be run from anywhere, as a user (If the using the command line parameters or if the AzureAD Module is installed already), as an Administrator or even as System. You could put this into an Automation Engine to do backups on a schedule if that is your desire but this would need to be done with an Azure App Registration.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-posh" data-lang="posh"><span style="color:#069;font-weight:bold">param</span>(
    [<span style="color:#069;font-weight:bold">Parameter</span>(DontShow = <span style="color:#033">$true</span>)]
    <span style="color:#360">[string]</span>
    <span style="color:#033">$MsGraphVersion</span> = <span style="color:#c30">&#34;beta&#34;</span>,
    [<span style="color:#069;font-weight:bold">Parameter</span>(DontShow = <span style="color:#033">$true</span>)]
    <span style="color:#360">[string]</span>
    <span style="color:#033">$MsGraphHost</span> = <span style="color:#c30">&#34;graph.microsoft.com&#34;</span>,
    <span style="color:#09f;font-style:italic">#The AzureAD ClientID (Application ID) of your registered AzureAD App</span>
    <span style="color:#360">[string]</span>
    <span style="color:#033">$ClientID</span>,
    <span style="color:#09f;font-style:italic">#The Client Secret for your AzureAD App</span>
    <span style="color:#360">[string]</span>
    <span style="color:#033">$ClientSecret</span>,
    <span style="color:#09f;font-style:italic">#Your Azure Tenent ID</span>
    <span style="color:#360">[string]</span>
    <span style="color:#033">$TenantId</span>,
    [<span style="color:#069;font-weight:bold">Parameter</span>()]
    <span style="color:#360">[string]</span>
    <span style="color:#033">$OutputFolder</span> = <span style="color:#c30">&#34;.\AppProtectionPolicyBackup&#34;</span>,
    <span style="color:#360">[switch]</span>
    <span style="color:#033">$Import</span>,
    <span style="color:#360">[string]</span>
    <span style="color:#033">$ImportJSON</span>
)<span style="color:#09f;font-style:italic">#</span>

<span style="color:#069;font-weight:bold">FUNCTION</span> <span style="color:#366">Connect-AzAD_Token</span> {
    <span style="color:#366">Write-Host</span> -ForegroundColor Cyan <span style="color:#c30">&#34;Checking for AzureAD module...&#34;</span>
    <span style="color:#033">$AADMod</span> = <span style="color:#366">Get-Module</span> -Name <span style="color:#c30">&#34;AzureAD&#34;</span> -ListAvailable

    <span style="color:#069;font-weight:bold">if</span> (!(<span style="color:#033">$AADMod</span>)) {
        <span style="color:#366">Write-Host</span> -ForegroundColor Yellow <span style="color:#c30">&#34;AzureAD PowerShell module not found, looking for AzureADPreview&#34;</span>
        <span style="color:#033">$AADModPrev</span> = <span style="color:#366">Get-Module</span> -Name <span style="color:#c30">&#34;AzureADPreview&#34;</span> -ListAvailable
        <span style="color:#09f;font-style:italic">#Check to see if the AzureAD Preview Module is insalled, If so se that as the AAD Module Else Insall the AzureAD Module</span>
        <span style="color:#069;font-weight:bold">IF</span> (<span style="color:#033">$AADModPrev</span>) {
            <span style="color:#033">$AADMod</span> = <span style="color:#366">Get-Module</span> -Name <span style="color:#c30">&#34;AzureADPreview&#34;</span> -ListAvailable
        } <span style="color:#069;font-weight:bold">else</span> {
            <span style="color:#069;font-weight:bold">try</span> {
                <span style="color:#366">Write-Host</span> -ForegroundColor Yello <span style="color:#c30">&#34;AzureAD Preview is not installed...&#34;</span>
                <span style="color:#366">Write-Host</span> -ForegroundColor Cyan <span style="color:#c30">&#34;Attempting to Install the AzureAD Powershell module...&#34;</span>
                <span style="color:#366">Install-PackageProvider</span> -Name NuGet -MinimumVersion 2.8.5.201 -Force -ErrorAction Stop | <span style="color:#366">Out-Null</span>
                <span style="color:#366">Install-Module</span> AzureAD -Force -ErrorAction Stop
            }
            <span style="color:#069;font-weight:bold">catch</span> {
                <span style="color:#366">Write-Host</span> -ForegroundColor Red <span style="color:#c30">&#34;Failed to install the AzureAD PowerShell Module </span><span style="color:#c30;font-weight:bold">`n</span><span style="color:#c30"> </span>$(<span style="color:#033">$Error</span>[0])<span style="color:#c30">&#34;</span>
                <span style="color:#069;font-weight:bold">break</span> 
            }
           
        }

    } <span style="color:#069;font-weight:bold">else</span> {
        <span style="color:#366">Write-Host</span> -ForegroundColor Green <span style="color:#c30">&#34;AzureAD Powershell Module Found&#34;</span>
    }

    <span style="color:#033">$AADMod</span> = (<span style="color:#033">$AADMod</span> | <span style="color:#366">Select-Object</span> -Unique | <span style="color:#366">Sort-Object</span>)[-1]
    
    <span style="color:#033">$ADAL</span> = <span style="color:#366">Join-Path</span> <span style="color:#033">$AADMod</span>.ModuleBase <span style="color:#c30">&#34;Microsoft.IdentityModel.Clients.ActiveDirectory.dll&#34;</span>
    <span style="color:#033">$ADALForms</span> = <span style="color:#366">Join-Path</span> <span style="color:#033">$AADMod</span>.ModuleBase <span style="color:#c30">&#34;Microsoft.IdentityModel.Clients.ActiveDirectory.Platform.dll&#34;</span>
    <span style="color:#360">[System.Reflection.Assembly]</span>::LoadFrom(<span style="color:#033">$ADAL</span>) | <span style="color:#366">Out-Null</span>
    <span style="color:#360">[System.Reflection.Assembly]</span>::LoadFrom(<span style="color:#033">$ADALForms</span>) | <span style="color:#366">Out-Null</span>

    <span style="color:#033">$UserInfo</span> = <span style="color:#366">Connect-AzureAD</span>

    <span style="color:#09f;font-style:italic"># Microsoft Intune PowerShell Enterprise Application ID </span>
    <span style="color:#033">$MIPEAClientID</span> = <span style="color:#c30">&#34;d1ddf0e4-d672-4dae-b554-9d5bdfd93547&#34;</span>
    <span style="color:#09f;font-style:italic"># The redirectURI</span>
    <span style="color:#033">$RedirectURI</span> = <span style="color:#c30">&#34;urn:ietf:wg:oauth:2.0:oob&#34;</span>
    <span style="color:#09f;font-style:italic">#The Authority to connect with (YOur Tenant)</span>
    <span style="color:#366">Write-Host</span> -Foregroundcolor Cyan <span style="color:#c30">&#34;Connected to Tenant: </span>$(<span style="color:#033">$UserInfo</span>.TenantID)<span style="color:#c30">&#34;</span>
    <span style="color:#033">$Auth</span> = <span style="color:#c30">&#34;https://login.microsoftonline.com/</span>$(<span style="color:#033">$UserInfo</span>.TenantID)<span style="color:#c30">&#34;</span>

    <span style="color:#069;font-weight:bold">try</span> {
        <span style="color:#033">$AuthContext</span> = <span style="color:#366">New-Object</span> <span style="color:#c30">&#34;Microsoft.IdentityModel.Clients.ActiveDirectory.AuthenticationContext&#34;</span> -ArgumentList <span style="color:#033">$Auth</span>
        
        <span style="color:#09f;font-style:italic"># https://msdn.microsoft.com/en-us/library/azure/microsoft.identitymodel.clients.activedirectory.promptbehavior.aspx</span>
        <span style="color:#09f;font-style:italic"># Change the prompt behaviour to force credentials each time: Auto, Always, Never, RefreshSession</span>
        <span style="color:#033">$platformParameters</span> = <span style="color:#366">New-Object</span> <span style="color:#c30">&#34;Microsoft.IdentityModel.Clients.ActiveDirectory.PlatformParameters&#34;</span> -ArgumentList <span style="color:#c30">&#34;Auto&#34;</span>
        <span style="color:#033">$userId</span> = <span style="color:#366">New-Object</span> <span style="color:#c30">&#34;Microsoft.IdentityModel.Clients.ActiveDirectory.UserIdentifier&#34;</span> -ArgumentList (<span style="color:#033">$UserInfo</span>.Account, <span style="color:#c30">&#34;OptionalDisplayableId&#34;</span>)
        <span style="color:#033">$authResult</span> = <span style="color:#033">$AuthContext</span>.AcquireTokenAsync((<span style="color:#c30">&#34;https://&#34;</span> + <span style="color:#033">$MSGraphHost</span>),<span style="color:#033">$MIPEAClientID</span>,<span style="color:#033">$RedirectURI</span>,<span style="color:#033">$platformParameters</span>,<span style="color:#033">$userId</span>).Result
        <span style="color:#09f;font-style:italic"># If the accesstoken is valid then create the authentication header</span>
        <span style="color:#069;font-weight:bold">if</span>(<span style="color:#033">$authResult</span>.AccessToken){
            <span style="color:#09f;font-style:italic"># Creating header for Authorization token</span>
            <span style="color:#033">$AADAccessToken</span> = <span style="color:#033">$authResult</span>.AccessToken
            <span style="color:#069;font-weight:bold">return</span> <span style="color:#033">$AADAccessToken</span>
        } <span style="color:#069;font-weight:bold">else</span> {
            <span style="color:#366">Write-Host</span> -ForegroundColor Red <span style="color:#c30">&#34;Authorization Access Token is null, please re-run authentication...&#34;</span>
            <span style="color:#069;font-weight:bold">break</span>
        }
    }
    <span style="color:#069;font-weight:bold">catch</span> {
        <span style="color:#366">Write-Host</span> -ForegroundColor Red <span style="color:#033">$_</span>.Exception.Message
        <span style="color:#366">Write-Host</span> -ForegroundColor Red <span style="color:#033">$_</span>.Exception.ItemName
        <span style="color:#069;font-weight:bold">break</span>
    }
}

<span style="color:#09f;font-style:italic"># Web page used to help with getting the access token </span>
<span style="color:#09f;font-style:italic">#https://morgantechspace.com/2019/08/get-graph-api-access-token-using-client-id-and-client-secret.html </span>

<span style="color:#069;font-weight:bold">if</span> ((<span style="color:#033">$ClientID</span>) <span style="color:#555">-and</span> (<span style="color:#033">$ClientSecret</span>) <span style="color:#555">-and</span> (<span style="color:#033">$TenantId</span>) ) {
    <span style="color:#09f;font-style:italic">#Create the body of the Authentication of the request for the OAuth Token</span>
    <span style="color:#033">$Body</span> = @{client_id=<span style="color:#033">$ClientID</span>;client_secret=<span style="color:#033">$ClientSecret</span>;grant_type=<span style="color:#c30">&#34;client_credentials&#34;</span>;scope=<span style="color:#c30">&#34;https://$MSGraphHost/.default&#34;</span>;}
    <span style="color:#09f;font-style:italic">#Get the OAuth Token </span>
    <span style="color:#033">$OAuthReq</span> = <span style="color:#366">Invoke-RestMethod</span> -Method Post -Uri <span style="color:#c30">&#34;https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token&#34;</span> -Body <span style="color:#033">$Body</span>
    <span style="color:#09f;font-style:italic">#Set your access token as a variable</span>
    <span style="color:#033">$global:AccessToken</span> = <span style="color:#033">$OAuthReq</span>.access_token
} <span style="color:#069;font-weight:bold">else</span> {
    <span style="color:#033">$global:AccessToken</span> = <span style="color:#366">Connect-AzAD_Token</span>
}

<span style="color:#069;font-weight:bold">IF</span> (!(<span style="color:#033">$Import</span>)) {
    <span style="color:#033">$FormattedOutputFolder</span> = <span style="color:#c30">&#34;$OutputFolder\</span>$(<span style="color:#366">Get-Date</span> -Format yyyyMMdd_HH-mm-ss)<span style="color:#c30">&#34;</span>

    <span style="color:#069;font-weight:bold">IF</span> (!(<span style="color:#366">Test-Path</span> <span style="color:#033">$FormattedOutputFolder</span>)){
        <span style="color:#069;font-weight:bold">try</span> {
            mkdir <span style="color:#033">$FormattedOutputFolder</span> -ErrorAction Stop | <span style="color:#366">Out-Null</span>
        }
        <span style="color:#069;font-weight:bold">catch</span> {
            <span style="color:#366">Write-Host</span> -ForegroundColor Red <span style="color:#c30">&#34;Failed to create $FormattedOutputFolder&#34;</span>
            <span style="color:#033">$Error</span>[0]
            <span style="color:#069;font-weight:bold">break</span>
        }
    }

    <span style="color:#366">Invoke-RestMethod</span> -Method GET -Uri <span style="color:#c30">&#34;https://$MSGraphHost/$MsGraphVersion/deviceAppManagement/managedAppPolicies&#34;</span> -Headers @{Authorization = <span style="color:#c30">&#34;Bearer $AccessToken&#34;</span>} | <span style="color:#366">Select-Object</span> -ExpandProperty <span style="color:#c30">&#34;Value&#34;</span> | %{
        <span style="color:#033">$_</span> | <span style="color:#366">ConvertTo-Json</span> | <span style="color:#366">Out-File</span> <span style="color:#c30">&#34;$FormattedOutputFolder\</span>$(<span style="color:#033">$_</span>.displayname)<span style="color:#c30">.json&#34;</span>
    }
 
}<span style="color:#069;font-weight:bold">elseif</span> (<span style="color:#033">$Import</span>) {
    <span style="color:#069;font-weight:bold">IF</span>(<span style="color:#033">$ImportJSON</span>) {
        <span style="color:#033">$JSON</span> = <span style="color:#366">Get-Content</span> <span style="color:#033">$ImportJSON</span> | <span style="color:#366">ConvertFrom-Json</span> | <span style="color:#366">Select-Object</span> -Property * -ExcludeProperty Version,LastModifiedTime,CreatedDateTime,id | <span style="color:#366">ConvertTo-Json</span>
        <span style="color:#366">Invoke-RestMethod</span> -Method POST -Uri <span style="color:#c30">&#34;https://$MSGraphHost/$MsGraphVersion/deviceAppManagement/managedAppPolicies&#34;</span> -Headers @{Authorization = <span style="color:#c30">&#34;Bearer $AccessToken&#34;</span>} -Body <span style="color:#033">$JSON</span> -ContentType <span style="color:#c30">&#34;application/json&#34;</span>
    } <span style="color:#069;font-weight:bold">else</span> {
        <span style="color:#366">Write-Host</span> -ForegroundColor RED <span style="color:#c30">&#34;You must specify an a JSON file using the -ImportJSON parameter&#34;</span>
    }
}
</code></pre></div><h2 id="the-pre-reqs">The Pre-Reqs</h2>
<h3 id="azure-ad-app-registration">Azure AD App Registration</h3>
<p>To make the script work without user interaction from an automation engine you will need an <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app">Azure App Registration</a> with the following permissions for the Microsoft Graph API;</p>
<h4 id="backing-up-app-protection-policies-only">Backing Up App Protection Policies Only</h4>
<ul>
 	<li><strong>DeviceManagementApps.Read.All </strong>(Application Permission)</li>
</ul>
<h4 id="importing-app-protection-policies">Importing <strong>App Protection Policies</strong></h4>
<ul>
 	<li><strong>DeviceManagementApps.ReadWrite.All</strong> (Application Permission)</li>
</ul>
<a href="https://docs.microsoft.com/en-us/graph/api/intune-mam-managedappprotection-list?view=graph-rest-beta">GRAPH API DOCUMENTATION</a>
<p>If you are not executing the script directly, you will also need the Tenant ID and the account that the script will be running as will need permission to the Output folder for backups.</p>
<p>If your not sure how to create an Azure AD App Registration head over to one of my other posts by clicking <a href="https://euc365.com/create_an_azure_app_registration">HERE</a>, Don&rsquo;t forget to store your Client ID and Secret securely and also have it to hand for the rest of the post :D.</p>
<h2 id="executing-the-script">Executing the Script</h2>
<h3 id="unattended-with-an-azure-ad-app-registration">Unattended with an Azure AD App Registration</h3>
<p>You can run this script directly from a PowerShell console, using Task Scheduler or using a 3rd party automation product that supports Powershell.</p>
<p>The main thing we will go through here is just the parameters and then putting them all together from the command line, it&rsquo;s really that simple.</p>
<h4 id="for-backup-only">For Backup Only</h4>
<ul>
 	<li>Client ID: This is the Client ID for your Azure AD App</li>
 	<li>ClientSecret: The Client Secret for the Azure AD App</li>
 	<li>TenantID: Your Azure Tenant ID</li>
 	<li>OutputFolder: Your desired Output folder</li>
</ul>
`./Backup_Import_AppProtectionPolicies.ps1 -ClientID "" -ClientSecret "" -TenantID "" -OutputFolder "./YourServerBackups/AppProtectionPolicies"`
<h4 id="for-importing-policies">For Importing Policies</h4>
<ul>
 	<li>Client ID: This is the Client ID for your Azure AD App</li>
 	<li>ClientSecret: The Client Secret for the Azure AD App</li>
 	<li>TenantID: Your Azure Tenant ID</li>
 	<li>Import: This is a switch parameter which states if your intention is to import or not</li>
 	<li>ImportJSON: the path to your JSON file.</li>
</ul>
You will finally end up with something like this;
<p><code>./Backup_Import_AppProtectionPolicies.ps1 -ClientID &quot;&quot; -ClientSecret &quot;&quot; -TenantID &quot;&quot; -Import -ImportJSON &quot;./YourServerBackups/AppProtectionPolicies/ImportMe.JSON&quot;</code></p>
<h3 id="direct-execution">Direct Execution</h3>
<p>If you launch the script without the Client ID, Secret and Tenant ID you will be prompted with a Microsoft Logon Window similar to the below.</p>
<p><img class="aligncenter" src="/images/post/backupappprotection/MSGraphWindow.png" alt="" width="565" height="394" /></p>
<p>Once you login the script will continue to run and then output the configuration files in the same way it would using the App Registration. You will need an account with permissions to be able to read (for backups only) or Read and Write the <strong>App Protection Policies</strong>. However the likelihood is that if you are looking at this guide you are probably an Intune Service Administrator or Global Administrator on your Tenant.</p>
<p>When you run it directly without any switches the script will prompt you to log in and it would only perform a backup of your profiles and output the configurations to the the folder you are executing it from.</p>
<p>If you add the <strong>-OutputFolder</strong> parameter you can change the destination of the base output folder. However if you are wishing to use the script to Import policies you can add the <strong>-Import </strong>and <strong>-ImportJSON </strong>parameters, If you specify the <strong>-Import </strong> parameter you must also specify the <strong>-ImportJSON </strong>parameter with a path to the JSON file (e.g. C:/ImportMe.json) otherwise the script will display a message that you did not specify the <strong>-ImportJSON</strong> Parameter.</p>
<p>You will notice that when you run the script, if the folder does not exist it will create it. It also put its into a dated folder in the <strong>yyyyMMdd_HH-mm-ss</strong> format leaving you with something like <strong>20200901_16_05_36</strong></p>
<h3 id="summary">Summary</h3>
<p>This can also be useful if you are wanting to make a copy of your policies to assign to a test machine. All you will need to do is backup your current policies and amend the JSON file, If you find the <strong>displayName</strong> field in the JSON file and amend it and save the file you will be able to re-import this the same settings. All you then need to do is assign it.</p>
<p>I have tested this myself at the time of writing the post but if you come across any information you think may be wrong then please leave a comment or e-mail me on <a href="mailto:David@euc365.com"><a href="mailto:david@euc365.com">david@euc365.com</a></a>.</p>
<p>I hope this is useful for your needs.</p>
</div>
      </div>
    </article>
    
    
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <div class="mt-5">
          <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "euc365-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      </div>
    </div>
    
  </div>
</section>




<footer class="section-sm pb-0 border-top border-default">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-md-3 mb-4">
        <a class="mb-4 d-block" href="/"><img class="img-fluid" width="150px" src="https://euc365.com/images/logo.png" alt="Home"></a>
        <p>Thank you for looking at my Tech, Tips and other bits.</p>
      </div>
      <div class="col-lg-2 col-md-3 col-6 mb-4">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled footer-list">
          
          
          <li><a href="https://euc365.com/about">About</a></li>
          
          
          <li><a href="https://euc365.com/contact">Contact</a></li>
          
          
          <li><a class="ot-sdk-show-settings" id="ot-sdk-btn">Cookie Settings</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-md-3 col-6 mb-4">
        <h6 class="mb-4">Social Links</h6>
        <ul class="list-unstyled footer-list">
          
          <li><a href="https://www.twitter.com/dbbrook24">Twitter</a></li>
          
          <li><a href="https://www.linkedin.com/in/david-brook-81796145/">linkedin</a></li>
          
          <li><a href="https://github.com/brookd2404">github</a></li>
          
        </ul>
      </div>
      
      <div class="col-md-3 mb-4">
        <h6 class="mb-4">Subscribe Newsletter</h6>
        
        <form class="subscription" action="https://euc365.us1.list-manage.com/subscribe/post?u=5be29b0e8342fd1942dd179e6&amp;amp;id=4afea5f508" method="post" name="mc-embedded-subscribe-form"
          target="_blank">
          <div class="position-relative">
            <i class="ti-email email-icon"></i>
            <input type="email" class="form-control" placeholder="Your Email Address">
          </div>
          <button class="btn btn-primary btn-block rounded" type="submit"
            name="subscribe">Subscribe now</button>
          <div style="position: absolute; left: -5000px;" aria-hidden="true">
            <input type="text" name="b_5be29b0e8342fd1942dd179e6_4afea5f508" tabindex="-1">
          </div>
        </form>
        
      </div>
      
    </div>
    <div class="scroll-top">
      <a href="javascript:void(0);" id="scrollTop"><i class="ti-angle-up"></i></a>
    </div>
    <div class="text-center">
      <p class="content">Design By <a href="https://euc365.com/">EUC365</a> Hosted By <a href="https://github.com/">GitHub</a></p>
    </div>
  </div>
</footer>








<script src="https://euc365.com/plugins/jQuery/jquery.min.js" ></script>



<script src="https://euc365.com/plugins/bootstrap/bootstrap.min.js" async></script>



<script src="https://euc365.com/plugins/slick/slick.min.js" ></script>









<script src="https://euc365.com/plugins/turbolinks/turbolinks.js" ></script>



<script src="https://cdn.snipcart.com/themes/v3.0.25/default/snipcart.js" async></script>




<div class="hidden" id="cookie-banner">
        <span class="cb-text">
            This may use 3rd Party Cookies to provide a great user experience. By continuing, you accept the use of these Cookies.
        </span>
        <span id="consent-cookies" class="cb-background">
            <b>Close</b>
        </span>
</div>

<script src="https://euc365.com/js/cookiebanner.min.js"></script>




<script src="https://euc365.com/js/script.min.js"></script></body>

</html>